# 活动

## 活动阶段

[活动开始时间|投票截止时间|比赛开始时间|比赛结束|活动结束时间]

### 时间顺序约束
- 活动开始时间 < 投票截止时间 ≤ 比赛开始时间 < 比赛结束时间 ≤ 活动结束时间

### 窗口定义
- 活动窗口：[活动开始时间-活动结束时间]
- 投票窗口：[活动开始时间-投票截止时间]
- 比赛窗口：自比赛开始时间起，若 matchEnd=false 则持续进行；若 matchEnd=true 则比赛已结束
- 奖励领取窗口：当 matchEnd=true 时开启，持续至活动结束时间


### 活动状态
- 草稿：未发布，时间可编辑
- 待开始：当前时间 < 活动开始时间
- 投票中：活动开始时间 ≤ 当前时间 < 投票截止时间
- 赛前：投票截止时间 ≤ 当前时间 < 比赛开始时间
- 比赛中：比赛开始时间 ≤ 当前时间 < 比赛结束时间
- 公示中：比赛结束时间 ≤ 当前时间 < 活动结束时间
- 已结束：当前时间 ≥ 活动结束时间

### 状态转移规则
- 随时间自动推进，禁止回退
- 已发布后，禁止修改已开始或已结束阶段的时间
- 未开始阶段允许延后，但不得提前或打破时间顺序约束
- 奖励领取仅允许在“奖励领取窗口”内进行

### 边界约定
- 所有时间使用同一时区，单位精确到分钟
- 窗口采用左闭右开，活动结束为右闭
- 若投票截止与比赛开始为同一时刻，视为无缝衔接
- 奖励领取窗口属于“公示中”阶段的子窗口；matchEnd 为布尔结束标记，无需具体时间戳




```tsx
export enum ActivityStatus {
  Pending = 1,
  Voting = 2,
  PreMatch = 3,
  Matching = 4,
  Publicizing = 5,
  Ended = 6,
}

export const ActivityStatusMap: Record<ActivityStatus, string> = {
  [ActivityStatus.Pending]: "待开始",
  [ActivityStatus.Voting]: "投票中",
  [ActivityStatus.PreMatch]: "赛前",
  [ActivityStatus.Matching]: "比赛中",
  [ActivityStatus.Publicizing]: "公示中",
  [ActivityStatus.Ended]: "已结束",
};

// 解析后的活动时间配置（matchEnd 使用布尔表示比赛是否结束）
export type ActivityResolved = {
  start: Date;
  voteEnd: Date;
  matchStart: Date;
  matchEnd: boolean;
  end: Date;
};

// 按生命周期计算当前状态
export function getStatus(now: Date, t: ActivityResolved): ActivityStatus {
  if (now < t.start) return ActivityStatus.Pending;
  if (now >= t.start && now < t.voteEnd) return ActivityStatus.Voting;
  if (now >= t.voteEnd && now < t.matchStart) return ActivityStatus.PreMatch;
  if (now >= t.matchStart && now < t.end)
    return t.matchEnd ? ActivityStatus.Publicizing : ActivityStatus.Matching;
  return ActivityStatus.Ended;
}

export const canVote = useMemo(() => {
  // 投票只能发生在投票窗口内
  if (status === ActivityStatus.Voting) {
    return true;
  }
}, [status]);

export const canAdvance = useMemo(() => {
  // 晋级只能发生在比赛之后的公式窗口期内
  if (status === ActivityStatus.Publicizing) {
    return true;
  }
}, [status, voted]);

export const canClaimReward = useMemo(() => {
  // 领奖只能发生在公示窗口期，并且需要用户投过票，且所投票的队伍已晋级
  if (voted && advanced && status === ActivityStatus.Publicizing) {
    return true;
  }
}, [status, voted, advanced]);
```
